---
title: "Shiny App Bootcamp"
author: "Pavla, Dariga, Constantin"
output: html_notebook
runtime: shiny
---


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(shiny)
library(tidyverse)
library(plotly)

## I am sorry, I couldn't get the Shiny App going :(

# For some reason the loop does not work with reactive values



```



```{r, echo = FALSE}
ui <- fluidPage(
  
  titlePanel(
    "Bootcamp"
  ),
  
  sidebarPanel(
    
    sliderInput("samplesize", "Select Sample Size", min = 1, max = 1000, value = 100),
    
    numericInput("mean_x", 
                 "mean group 1", value = 0), 
    
    numericInput("mean_y", "mean group 2", value  = 0),
    
    numericInput("sd_x", "Standard deviation group 1", value = 1, min = 0.001), 
    
    numericInput("sd_y", "Standard deviation group 2", value = 1, min = 0.001),
    
    selectInput("test", "Which test do you want to use?", choices = c("t.test", "z.test", "wilcox.test")), 
    
    numericInput("n_sim", "How many simulation repetitions?", value = 100),
    
    numericInput("alpha", "What alpha do you want?", value = 0.05, min = 0.001, max = 0.1),
    
    selectInput("sim_alpha", "Do you want to simulate alpha", choices = c("TRUE", "FALSE"))
    
  ),
  
  
  
  mainPanel( 
    tabsetPanel(
      
      tabPanel("list",
               
               verbatimTextOutput("text")
               
               #textOutput("list")
               
      ),
      
      tabPanel("Plot",
               
               #plotOutput("plot"),
               
               textOutput("dec"),
               
               textOutput("testt")
               
      )
    )
  )
)

server <- function(input, output){
  
  vals <- reactiveValues(samplesize = 100, mean_x = 0, mean_y = 0, sd_x = 1, sd_x = 1, test = "t.test", alpha = 0.05, n_sim = 100, sim_alpha = "TRUE")
  
  observe({
    vals$samplesize <- input$samplesize
  })
  
  observe({
    vals$mean_x <- input$mean_x
  })
  
  observe({
    vals$mean_y <- input$mean_y
  })
  
  observe({
    vals$sd_x <- input$sd_x
  })
  
  observe({
    vals$sd_y <- input$sd_y
  })
  
  observe({
    vals$test <- input$test
  })
  
  observe({
    vals$alpha <- input$alpha
  })
  
  observe({
    vals$n_sim <- input$n_sim
  })
  
  observe({
    vals$sim_alpha <- input$sim_alpha
  })
  
  observe({
    vals$decision <- 1:input$n_sim
  })
  
  observe({
    vals$test_res <- rep(NA, input$n_sim)
  })
  
  
  ## z_test function
  z_test <- function(x, y, sd=1, delta=0){
  
  n_x <- length(x)
  n_y <- length(y)
  
  # calculate the z-statistic
  z_stat <- (mean(x) - mean(y) - delta) /
    sqrt(sd^2/n_x + sd^2/n_y)
  
  
  pvalue <- 1-pnorm(abs(z_stat))
  #decision <- (pvalue < 0.05)
  
  return(list(z_stat=z_stat, p.value=pvalue))
}

  
  observe({
  #decision <- rep(NA, vals$n_sim)
  
  #for(i in 1:10){
    vals$x <- rnorm(vals$samplesize, mean = vals$mean_x, sd = vals$sd_x)
    vals$y <- rnorm(vals$samplesize, mean = vals$mean_y, sd = vals$sd_y)
    
    
    #vals$test_res <- t.test(vals$x, vals$y)$p.value
    if(vals$test == "t.test"){
      vals$test_res <- t.test(vals$x, vals$y)$p.value
    }

    if(vals$test == "wilcox.test"){
      vals$test_res <- t.test(vals$x, vals$y)$p.value
    }

    if(vals$test == "z.test"){
      vals$test_res <- z_test(vals$x, vals$y, vals$sd_x)$p.value
    }
    
    vals$decision[1] <- (vals$test_res < vals$alpha)
    
    #}
    
    vals$power <- mean(vals$decision)
  
 
  })
  
  
    
    
    
  # observe({
  #   if(vals$sim_alpha == "TRUE"){
  #     
  # #decision <- rep(NA, vals$n_sim)
  # 
  # #for(i in 1:10){
  #   vals$x <- rnorm(vals$samplesize, mean = vals$mean_x, sd = vals$sd_x)
  #   vals$y <- rnorm(vals$samplesize, mean = vals$mean_x, sd = vals$sd_x)
  #   
  #   
  #   #vals$test_res <- t.test(vals$x, vals$y)$p.value
  #   if(vals$test == "t.test"){
  #     vals$test_res <- t.test(vals$x, vals$y)$p.value
  #   }
  # 
  #   if(vals$test == "wilcox.test"){
  #     vals$test_res <- t.test(vals$x, vals$y)$p.value
  #   }
  # 
  #   if(vals$test == "z.test"){
  #     vals$test_res <- z_test(vals$x, vals$y, vals$sd_x)$p.value
  #   }
  #   
  #   vals$decision[1] <- (vals$test_res < vals$alpha)
  # #}
  # 
  #   vals$alpha <- mean(vals$decision)
  #   }
  # 
  # })
  
  # output$plot <-  renderPlot({
  #   plot(
  #     vals$x, vals$y
  #   )
  # })
  
  output$testt <- renderPrint({
    vals$n_sim
  })
  
  output$dec <- renderText({
    vals$power
  })
}           


shinyApp(ui, server)            
```


```{r, echo = FALSE}
# calculate the z-statistic

z_test <- function(x, y, sd=1, delta=0){
  
  n_x <- length(x)
  n_y <- length(y)
  
  # calculate the z-statistic
  z_stat <- (mean(x) - mean(y) - delta) /
    sqrt(sd^2/n_x + sd^2/n_y)
  
  
  pvalue <- 1-pnorm(abs(z_stat))
  #decision <- (pvalue < 0.05)
  
  return(list(z_stat=z_stat, p.value=pvalue))
}

```




